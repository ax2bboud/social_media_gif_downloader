name: Build Executables

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pyinstaller

    - name: Build Windows executable
      run: pyinstaller social_media_gif_downloader.spec

    - name: Prepare Windows artifact
      run: |
        Compress-Archive -Path dist\SocialMediaGIFDownloader.exe -DestinationPath SocialMediaGIFDownloader-Windows-x64.zip

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: SocialMediaGIFDownloader-Windows-x64.zip

  build-macos:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pyinstaller
        brew install create-dmg

    - name: Build macOS app
      run: pyinstaller social_media_gif_downloader.spec

    - name: Create DMG
      run: |
        mkdir -p dist/dmg
        cp -r dist/SocialMediaGIFDownloader.app dist/dmg/
        create-dmg \
          --volname "Social Media GIF Downloader" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --app-drop-link 450 185 \
          --hide-extension "SocialMediaGIFDownloader.app" \
          "SocialMediaGIFDownloader-macOS.dmg" \
          "dist/dmg/" || cp -r dist/SocialMediaGIFDownloader.app dist/SocialMediaGIFDownloader.app

    - name: Fallback to ZIP if DMG creation fails
      if: failure()
      run: |
        cd dist
        zip -r ../SocialMediaGIFDownloader-macOS.zip SocialMediaGIFDownloader.app

    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-executable
        path: |
          SocialMediaGIFDownloader-macOS.dmg
          SocialMediaGIFDownloader-macOS.zip
        if-no-files-found: ignore

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libfuse2 \
          file \
          wget \
          desktop-file-utils \
          zsync

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pyinstaller

    - name: Build Linux executable
      run: pyinstaller social_media_gif_downloader.spec

    - name: Download appimagetool
      run: |
        wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage

    - name: Create AppDir structure
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        cp dist/SocialMediaGIFDownloader AppDir/usr/bin/
        
        # Create desktop entry
        cat > AppDir/usr/share/applications/social-media-gif-downloader.desktop << EOF
        [Desktop Entry]
        Type=Application
        Name=Social Media GIF Downloader
        Comment=Download videos and GIFs from social media
        Exec=SocialMediaGIFDownloader
        Icon=social-media-gif-downloader
        Categories=Network;AudioVideo;
        Terminal=false
        EOF
        
        # Copy icon if exists, otherwise create a symlink to the desktop file
        if [ -f app_icon.ico ]; then
          cp app_icon.ico AppDir/usr/share/icons/hicolor/256x256/apps/social-media-gif-downloader.png || true
        fi
        
        # Create AppRun
        cat > AppDir/AppRun << 'EOF'
        #!/bin/bash
        SELF=$(readlink -f "$0")
        HERE=${SELF%/*}
        export PATH="${HERE}/usr/bin/:${PATH}"
        exec "${HERE}/usr/bin/SocialMediaGIFDownloader" "$@"
        EOF
        chmod +x AppDir/AppRun
        
        # Copy desktop file to root
        cp AppDir/usr/share/applications/social-media-gif-downloader.desktop AppDir/

    - name: Build AppImage
      run: |
        ./appimagetool-x86_64.AppImage AppDir SocialMediaGIFDownloader-Linux-x86_64.AppImage

    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-executable
        path: SocialMediaGIFDownloader-Linux-x86_64.AppImage

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        find artifacts -type f -exec cp {} release-assets/ \;
        ls -la release-assets/

    - name: Generate release notes
      id: release_notes
      run: |
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        if [ -n "$PREVIOUS_TAG" ]; then
          NOTES=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD)
        else
          NOTES=$(git log --pretty=format:"- %s" --max-count=10)
        fi
        
        {
          echo "notes<<EOF"
          echo "## Changes in v${{ steps.get_version.outputs.version }}"
          echo ""
          echo "$NOTES"
          echo ""
          echo "## Platform-Specific Downloads"
          echo ""
          echo "- **Windows**: Download \`SocialMediaGIFDownloader-Windows-x64.zip\`, extract, and run the .exe file"
          echo "- **macOS**: Download \`.dmg\` or \`.zip\`, open/extract, and drag to Applications folder"
          echo "- **Linux**: Download \`.AppImage\`, make it executable (\`chmod +x\`), and run"
          echo ""
          echo "## System Requirements"
          echo ""
          echo "- Windows 10 or later (64-bit)"
          echo "- macOS 10.15 (Catalina) or later"
          echo "- Linux (x86_64) with FUSE support"
          echo "EOF"
        } >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.get_version.outputs.version }}
        name: Release v${{ steps.get_version.outputs.version }}
        body: ${{ steps.release_notes.outputs.notes }}
        files: release-assets/*
        draft: false
        prerelease: false
