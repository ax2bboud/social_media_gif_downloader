name: Build Executables

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pyinstaller
        pip install imageio-ffmpeg

    - name: Download and bundle ffmpeg
      run: |
        # Create a temporary directory for ffmpeg download
        New-Item -ItemType Directory -Force -Path ffmpeg_temp
        
        # Download ffmpeg-essentials for Windows
        $ffmpegUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
        Invoke-WebRequest -Uri $ffmpegUrl -OutFile ffmpeg_temp/ffmpeg.zip
        
        # Extract ffmpeg
        Expand-Archive -Path ffmpeg_temp/ffmpeg.zip -DestinationPath ffmpeg_temp
        
        # Find and copy the ffmpeg.exe binary to the root directory
        $ffmpegExe = Get-ChildItem -Path ffmpeg_temp -Filter ffmpeg.exe -Recurse | Select-Object -First 1
        if ($ffmpegExe) {
          Copy-Item $ffmpegExe.FullName -Destination ffmpeg.exe
          Write-Host "FFmpeg copied to: $(Get-Location)\ffmpeg.exe"
        } else {
          Write-Error "ffmpeg.exe not found after extraction"
          exit 1
        }
        
        # Clean up temp directory
        Remove-Item -Recurse -Force ffmpeg_temp

    - name: Verify ffmpeg
      run: |
        if (Test-Path ffmpeg.exe) {
          Write-Host "FFmpeg found: $(Get-Item ffmpeg.exe)"
          .\ffmpeg.exe -version
        } else {
          Write-Error "ffmpeg.exe not found"
          exit 1
        }

    - name: Build Windows executable
      run: pyinstaller social_media_gif_downloader.spec

    - name: Verify executable exists
      run: |
        if (Test-Path dist\SocialMediaGIFDownloader.exe) {
          Write-Host "Executable built successfully"
          Get-Item dist\SocialMediaGIFDownloader.exe
        } else {
          Write-Error "Executable not found"
          exit 1
        }

    - name: Prepare Windows artifact
      run: |
        Compress-Archive -Path dist\SocialMediaGIFDownloader.exe -DestinationPath SocialMediaGIFDownloader-Windows-x64.zip

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: SocialMediaGIFDownloader-Windows-x64.zip

  build-macos:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pyinstaller
        pip install imageio-ffmpeg
        brew install create-dmg

    - name: Download and bundle ffmpeg
      run: |
        # Create a temporary directory for ffmpeg download
        mkdir -p ffmpeg_temp
        
        # Download ffmpeg for macOS
        curl -L https://evermeet.cx/ffmpeg/getrelease/ffmpeg/zip -o ffmpeg_temp/ffmpeg.zip
        
        # Extract ffmpeg
        cd ffmpeg_temp
        unzip ffmpeg.zip
        cd ..
        
        # Copy ffmpeg binary to root
        cp ffmpeg_temp/ffmpeg ffmpeg
        chmod +x ffmpeg
        
        # Verify
        ./ffmpeg -version
        
        # Clean up temp directory
        rm -rf ffmpeg_temp

    - name: Build macOS app
      run: pyinstaller social_media_gif_downloader.spec

    - name: Verify app bundle
      run: |
        if [ -d "dist/SocialMediaGIFDownloader.app" ]; then
          echo "App bundle created successfully"
          ls -la dist/SocialMediaGIFDownloader.app/Contents/MacOS/
        else
          echo "App bundle not found"
          exit 1
        fi

    - name: Create DMG
      run: |
        mkdir -p dist/dmg
        cp -r dist/SocialMediaGIFDownloader.app dist/dmg/
        create-dmg \
          --volname "Social Media GIF Downloader" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --app-drop-link 450 185 \
          --hide-extension "SocialMediaGIFDownloader.app" \
          "SocialMediaGIFDownloader-macOS.dmg" \
          "dist/dmg/" || cp -r dist/SocialMediaGIFDownloader.app dist/SocialMediaGIFDownloader.app

    - name: Fallback to ZIP if DMG creation fails
      if: failure()
      run: |
        cd dist
        zip -r ../SocialMediaGIFDownloader-macOS.zip SocialMediaGIFDownloader.app

    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-executable
        path: |
          SocialMediaGIFDownloader-macOS.dmg
          SocialMediaGIFDownloader-macOS.zip
        if-no-files-found: ignore

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libfuse2 \
          file \
          wget \
          desktop-file-utils \
          zsync \
          python3-tk

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pyinstaller
        pip install imageio-ffmpeg

    - name: Download and bundle ffmpeg
      run: |
        # Create a temporary directory for ffmpeg download
        mkdir -p ffmpeg_temp
        
        # Download ffmpeg static build for Linux
        wget https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz -O ffmpeg_temp/ffmpeg.tar.xz
        
        # Extract ffmpeg
        cd ffmpeg_temp
        tar -xf ffmpeg.tar.xz
        cd ..
        
        # Find and copy the ffmpeg binary
        find ffmpeg_temp -name ffmpeg -type f -executable -exec cp {} ffmpeg \;
        chmod +x ffmpeg
        
        # Verify
        ./ffmpeg -version
        
        # Clean up temp directory
        rm -rf ffmpeg_temp

    - name: Build Linux executable
      run: pyinstaller social_media_gif_downloader.spec

    - name: Verify executable exists
      run: |
        if [ -f "dist/SocialMediaGIFDownloader" ]; then
          echo "Executable built successfully"
          ls -lh dist/SocialMediaGIFDownloader
        else
          echo "Executable not found"
          exit 1
        fi

    - name: Download appimagetool
      run: |
        wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage

    - name: Create AppDir structure
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        cp dist/SocialMediaGIFDownloader AppDir/usr/bin/
        
        # Create desktop entry
        cat > AppDir/usr/share/applications/social-media-gif-downloader.desktop << EOF
        [Desktop Entry]
        Type=Application
        Name=Social Media GIF Downloader
        Comment=Download videos and GIFs from social media
        Exec=SocialMediaGIFDownloader
        Icon=social-media-gif-downloader
        Categories=Network;AudioVideo;
        Terminal=false
        EOF
        
        # Copy icon if exists, otherwise create a placeholder icon
        if [ -f app_icon.ico ]; then
          cp app_icon.ico AppDir/usr/share/icons/hicolor/256x256/apps/social-media-gif-downloader.png || true
        fi
        # Always create a minimal placeholder icon file in AppDir root (1x1 transparent PNG)
        echo -e '\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x01\x00\x00\x00\x01\x08\x06\x00\x00\x00\x1f\x15\xc4\x89\x00\x00\x00\nIDATx\x9cc\x00\x01\x00\x00\x05\x00\x01\r\n-\xdb\x00\x00\x00\x00IEND\xaeB`\x82' > AppDir/social-media-gif-downloader.png
        
        # Create AppRun
        cat > AppDir/AppRun << 'EOF'
        #!/bin/bash
        SELF=$(readlink -f "$0")
        HERE=${SELF%/*}
        export PATH="${HERE}/usr/bin/:${PATH}"
        exec "${HERE}/usr/bin/SocialMediaGIFDownloader" "$@"
        EOF
        chmod +x AppDir/AppRun
        
        # Copy desktop file to root
        cp AppDir/usr/share/applications/social-media-gif-downloader.desktop AppDir/

    - name: Build AppImage
      run: |
        ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir SocialMediaGIFDownloader-Linux-x86_64.AppImage

    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-executable
        path: SocialMediaGIFDownloader-Linux-x86_64.AppImage

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        find artifacts -type f -exec cp {} release-assets/ \;
        ls -la release-assets/

    - name: Generate release notes
      id: release_notes
      run: |
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        if [ -n "$PREVIOUS_TAG" ]; then
          NOTES=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD)
        else
          NOTES=$(git log --pretty=format:"- %s" --max-count=10)
        fi
        
        {
          echo "notes<<EOF"
          echo "## Changes in v${{ steps.get_version.outputs.version }}"
          echo ""
          echo "$NOTES"
          echo ""
          echo "## Platform-Specific Downloads"
          echo ""
          echo "- **Windows**: Download \`SocialMediaGIFDownloader-Windows-x64.zip\`, extract, and run the .exe file"
          echo "- **macOS**: Download \`.dmg\` or \`.zip\`, open/extract, and drag to Applications folder"
          echo "- **Linux**: Download \`.AppImage\`, make it executable (\`chmod +x\`), and run"
          echo ""
          echo "## System Requirements"
          echo ""
          echo "- Windows 10 or later (64-bit)"
          echo "- macOS 10.15 (Catalina) or later"
          echo "- Linux (x86_64) with FUSE support"
          echo ""
          echo "## What's Included"
          echo ""
          echo "All executables are standalone and include:"
          echo "- Python runtime"
          echo "- FFmpeg for video processing"
          echo "- yt-dlp for downloading"
          echo "- All required dependencies"
          echo ""
          echo "No additional software installation required!"
          echo "EOF"
        } >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.get_version.outputs.version }}
        name: Release v${{ steps.get_version.outputs.version }}
        body: ${{ steps.release_notes.outputs.notes }}
        files: release-assets/*
        draft: false
        prerelease: false
